name: Diagnose Atlas Labels Schema

on:
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install embedding-atlas pandas pyarrow

      - name: Atlas version
        run: |
          echo "=== embedding-atlas version ==="
          python3 -c "import embedding_atlas; print(embedding_atlas.__version__)" \
            || embedding-atlas --version \
            || pip show embedding-atlas

      - name: Atlas labels schema — what columns does it expect?
        run: |
          echo "=== embedding_atlas module help (first 80 lines) ==="
          python3 -c "import embedding_atlas; help(embedding_atlas)" 2>&1 | head -80 || true

          echo ""
          echo "=== Search source for 'level' and 'label' column references ==="
          python3 -c "
          import embedding_atlas, inspect, pathlib
          src_dir = pathlib.Path(inspect.getfile(embedding_atlas)).parent
          print('Source dir:', src_dir)
          for f in src_dir.rglob('*.py'):
              text = f.read_text(errors='ignore')
              if any(kw in text for kw in ['level', 'label_column', 'labels']):
                  print(f'\n--- {f.relative_to(src_dir)} ---')
                  for i, line in enumerate(text.splitlines(), 1):
                      if any(kw in line.lower() for kw in ['level', 'label']):
                          print(f'  {i:4d}: {line}')
          "

      - name: Inspect current labels.parquet (if present)
        run: |
          echo "=== labels.parquet contents ==="
          python3 -c "
          import pandas as pd, os
          path = 'labels.parquet'
          if os.path.exists(path):
              df = pd.read_parquet(path)
              print('Shape:', df.shape)
              print('Columns:', df.columns.tolist())
              print('Dtypes:\n', df.dtypes)
              print('Sample:\n', df.head(10).to_string())
          else:
              print('labels.parquet not found — run a build first')
          "

      - name: Write a test labels.parquet with level column and run Atlas
        run: |
          echo "=== Testing --labels with level column ==="
          python3 -c "
          import pandas as pd, numpy as np

          # Minimal fake dataset
          n = 30
          df = pd.DataFrame({
              'title':        [f'Paper {i}' for i in range(n)],
              'abstract':     [f'Abstract text for paper {i}.' for i in range(n)],
              'projection_x': np.random.uniform(0, 10, n),
              'projection_y': np.random.uniform(0, 10, n),
          })
          df.to_parquet('test_data.parquet', index=False)

          # Labels: 2 primary + 4 sub-labels with level column
          labels = pd.DataFrame([
              {'x': 2.5, 'y': 2.5, 'text': 'Primary A',   'level': 0},
              {'x': 7.5, 'y': 7.5, 'text': 'Primary B',   'level': 0},
              {'x': 1.5, 'y': 3.5, 'text': 'Sub A1',      'level': 1},
              {'x': 3.5, 'y': 1.5, 'text': 'Sub A2',      'level': 1},
              {'x': 6.5, 'y': 8.5, 'text': 'Sub B1',      'level': 1},
              {'x': 8.5, 'y': 6.5, 'text': 'Sub B2',      'level': 1},
          ])
          labels.to_parquet('test_labels.parquet', index=False)
          print('test_labels.parquet written:')
          print(labels.to_string())
          "

          embedding-atlas test_data.parquet \
            --x projection_x \
            --y projection_y \
            --labels test_labels.parquet \
            --export-application test_site.zip \
            && echo "Atlas build succeeded" \
            || echo "Atlas build FAILED — level column may not be supported"

          echo ""
          echo "=== Inspect generated metadata.json for label-related keys ==="
          unzip -p test_site.zip "*/metadata.json" 2>/dev/null \
            | python3 -c "import json,sys; d=json.load(sys.stdin); print(json.dumps(d, indent=2))" \
            || echo "Could not extract metadata.json from zip"
